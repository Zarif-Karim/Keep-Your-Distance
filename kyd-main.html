<!-- 

Author : Zarif Jawadul Karim
Date-Created: 16/05/2021
Description: Attempt to convert cpp codebase to JS and HTML

References: <ADD-References>

Copyright (c) 2021, Zarif-Karim
All rights reserved. 

-->


<!DOCTYPE html>
<html>
  <head>
    <title>Phase 1</title>
    <meta charset="UTF-8" />
  </head>

  <body>
	<p id="status">OpenCV.js is loading...</p>
    <div>
      <video id="videoInput"></video> <canvas id="canvasOutput"></canvas>
    </div>
	<script type="text/javascript">
		
		//Video capture...
		let video = document.getElementById("videoInput");
		navigator.mediaDevices.getUserMedia({ video: true, audio: false })
				.then(function(stream) {
					video.srcObject = stream;
					video.play();
				})
				.catch(function(err) {
					console.log("An error occurred! " + err);
				});
	
		
		function onOpenCvReady() {
			//update status
			document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
			  
			let	source = new cv.Mat(video.height, video.width, cv.CV_8UC4);
			let	dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);
			let	cap = new cv.VideoCapture(video);
			
			const FPS = 30;		
			function processVideo() {
				try {
					//if (!streaming) {
						// clean and stop.
						//source.delete();
						//dst.delete();
						//return;
					//}
					let begin = Date.now();
					// start processing.
					cap.read(source);
					cv.cvtColor(source, dst, cv.COLOR_RGBA2GRAY);
					cv.imshow('canvasOutput', dst);
					// schedule the next one.
					let delay = 1000/FPS - (Date.now() - begin);
					setTimeout(processVideo, delay);
				} catch (err) {
					console.log("An error occurred! " + err);
				}
					};
					
			// schedule the first one.
			setTimeout(processVideo, 0);
		}

	</script>
	<script async src="opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
  </body>
</html>
